-- Serviços
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local selectedPlayerName = nil

-- Carregar Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/tiololo487/Script/refs/heads/main/library"))()

workspace.FallenPartsDestroyHeight = -math.huge

-- Criar Janela
local Window = Library:MakeWindow({
    Title = "anonymus Hub | Brookhaven",
    SubTitle = "By: silvadev",
    LoadText = "Carregando anonymus Hub...",
    Flags = "anonymushub_Brookhaven",
    Size = UDim2.fromScale(0.55, 0.65)
})

Window:AddMinimizeButton({
    Button = { Image = "rbxassetid://2483186", BackgroundTransparency = 0 },
    Corner = { CornerRadius = UDim.new(35, 1) },
})

-- Criar Tab
local Troll = Window:MakeTab({
    Title = "| Troll",
    Icon = "rbxassetid://15309138473"
})

------------------------------------------------------------------
-- Função para pegar lista de jogadores
------------------------------------------------------------------
local function getPlayerList()
    local playerNames = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(playerNames, player.Name)
        end
    end
    return playerNames
end

------------------------------------------------------------------
-- Dropdown de jogadores
------------------------------------------------------------------
local playerDropdown = Troll:AddDropdown({
    Name = "Select Player",
    Options = getPlayerList(),
    Default = "",
    Callback = function(value)
        selectedPlayerName = value
        print("Selected player:", value)
    end
})

------------------------------------------------------------------
-- Botão atualizar lista
------------------------------------------------------------------
Troll:AddButton({
    Name = "Refresh Player List",
    Callback = function()
        local newList = getPlayerList()

        -- Atualiza opções do dropdown dependendo da biblioteca
        if playerDropdown.Refresh then
            playerDropdown:Refresh(newList) -- se a library tiver Refresh
        elseif playerDropdown.SetOptions then
            playerDropdown:SetOptions(newList) -- se tiver SetOptions
        elseif playerDropdown.UpdateOptions then
            playerDropdown:UpdateOptions(newList) -- outra possível função
        else
            warn("Dropdown não suporta atualização automática de opções")
        end

        -- Resetar seleção se o jogador atual não existir mais
        if selectedPlayerName and not game.Players:FindFirstChild(selectedPlayerName) then
            selectedPlayerName = nil
            if playerDropdown.Set then
                playerDropdown:Set("") -- reseta valor selecionado
            elseif playerDropdown.SetValue then
                playerDropdown:SetValue("") -- outra possibilidade de função
            end
        end
    end
})

local stopFling = nil

local function FlingBallVertical(target)
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local player = Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local backpack = player:WaitForChild("Backpack")
    local WorkspaceCom = workspace:WaitForChild("WorkspaceCom")
    local ServerBalls = WorkspaceCom:WaitForChild("001_SoccerBalls")

    -- Função para pegar a bola
    local function GetBall()
        local ballName = "Soccer" .. player.Name
        local Ball = ServerBalls:FindFirstChild(ballName)
        if not Ball then
            local tool = ReplicatedStorage:FindFirstChild("RE") and ReplicatedStorage.RE:FindFirstChild("1Too1l")
            if tool then
                tool:InvokeServer("PickingTools", "SoccerBall")
                repeat task.wait() until backpack:FindFirstChild("SoccerBall")
                backpack.SoccerBall.Parent = character
                repeat task.wait() until ServerBalls:FindFirstChild(ballName)
                Ball = ServerBalls:FindFirstChild(ballName)
            end
        end
        return Ball
    end

    local Ball = GetBall()
    if not Ball then return end

    Ball.CanCollide = false
    Ball.Massless = true
    Ball.CustomPhysicalProperties = PhysicalProperties.new(0.0001,0,0)

    -- Checa alvo válido
    if not target or target == player then return end
    local tchar = target.Character
    if not tchar then return end
    local torso = tchar:FindFirstChild("UpperTorso") or tchar:FindFirstChild("Torso")
    if not torso then return end

    -- Limpar objetos físicos antigos
    for _, v in pairs(Ball:GetChildren()) do
        if v:IsA("BodyPosition") or v:IsA("BodyVelocity") or v:IsA("BodyGyro") then
            v:Destroy()
        end
    end

    -- BodyPosition para manter no torso
    local bp = Instance.new("BodyPosition")
    bp.MaxForce = Vector3.new(1e6,1e6,1e6)
    bp.P = 5e4
    bp.D = 100
    bp.Position = torso.Position
    bp.Parent = Ball

    local running = true
    local direction = 1
    local heightRange = 5 -- altura máxima de cima para baixo
    stopFling = function()
        running = false
        if bp then bp:Destroy() end
    end

    spawn(function()
        while running and torso.Parent and tchar:FindFirstChild("Humanoid") and tchar.Humanoid.Health > 0 do
            -- Verifica se a bola caiu no chão
            if Ball.Position.Y < torso.Position.Y - heightRange then
                -- Reposiciona imediatamente no torso
                bp.Position = torso.Position + Vector3.new(0, heightRange/2, 0)
            else
                -- Movimento vertical contínuo
                direction = direction * -1
                local offset = Vector3.new(0, (heightRange/2) * direction, 0)
                bp.Position = torso.Position + offset
            end
            task.wait(0.03)
        end
        stopFling()
    end)
end

-- Toggle Fling Ball Vertical
Troll:AddToggle({
    Name = "Fling Ball Vertical",
    Default = false,
    Callback = function(state)
        local target = game.Players:FindFirstChild(selectedPlayerName)
        if state then
            if target then
                FlingBallVertical(target)
                print("Fling Vertical Ligado")
            else
                warn("Selecione um jogador!")
            end
        else
            if stopFling then
                stopFling()
                stopFling = nil
                print("Fling Vertical Desligado")
            end
        end
    end
})

local stopBallLoop = nil

local function BallVerticalLoop(target)
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local RunService = game:GetService("RunService")

    local player = Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local backpack = player:WaitForChild("Backpack")
    local WorkspaceCom = workspace:WaitForChild("WorkspaceCom")
    local ServerBalls = WorkspaceCom:WaitForChild("001_SoccerBalls")

    -- Função para pegar a bola
    local function GetBall()
        local ballName = "Soccer" .. player.Name
        local Ball = ServerBalls:FindFirstChild(ballName)
        if not Ball then
            local tool = ReplicatedStorage:FindFirstChild("RE") and ReplicatedStorage.RE:FindFirstChild("1Too1l")
            if tool then
                tool:InvokeServer("PickingTools", "SoccerBall")
                repeat task.wait() until backpack:FindFirstChild("SoccerBall")
                backpack.SoccerBall.Parent = character
                repeat task.wait() until ServerBalls:FindFirstChild(ballName)
                Ball = ServerBalls:FindFirstChild(ballName)
            end
        end
        return Ball
    end

    local Ball = GetBall()
    if not Ball then 
        warn("Bola não encontrada.")
        return 
    end

    Ball.CanCollide = false
    Ball.Massless = true
    Ball.CustomPhysicalProperties = PhysicalProperties.new(0.0001, 0, 0)

    -- Checa alvo válido
    if not target or target == player then 
        warn("Alvo inválido.")
        return 
    end
    local tchar = target.Character
    if not tchar then 
        warn("Alvo não tem personagem.")
        return 
    end
    local torso = tchar:FindFirstChild("UpperTorso") or tchar:FindFirstChild("Torso")
    if not torso then 
        warn("Alvo não tem torso.")
        return 
    end

    -- Limpar objetos físicos antigos
    for _, v in pairs(Ball:GetChildren()) do
        if v:IsA("BodyPosition") or v:IsA("BodyVelocity") or v:IsA("BodyGyro") then
            v:Destroy()
        end
    end

    -- Teletransporta a bola para o torso do alvo imediatamente
    Ball.CFrame = torso.CFrame * CFrame.new(0, 3, 0)

    -- Cria BodyPosition para manter a bola no torso
    local bp = Instance.new("BodyPosition")
    bp.MaxForce = Vector3.new(1e7, 1e7, 1e7) -- Força maior para melhor controle
    bp.P = 1e5
    bp.D = 1e4
    bp.Position = Ball.Position
    bp.Parent = Ball

    local running = true
    local direction = 1
    local heightRange = 6 -- altura máxima de cima para baixo
    local speed = 10 -- velocidade do movimento vertical

    stopBallLoop = function()
        running = false
        if bp then bp:Destroy() end
    end

    local startTime = tick()

    local connection
    connection = RunService.Heartbeat:Connect(function(dt)
        if not running or not torso.Parent or not tchar:FindFirstChild("Humanoid") or tchar.Humanoid.Health <= 0 then
            connection:Disconnect()
            stopBallLoop()
            return
        end

        -- Atualiza a posição alvo do BodyPosition para seguir o torso com movimento vertical oscilante
        local elapsed = tick() - startTime
        local verticalOffset = math.sin(elapsed * speed) * (heightRange / 2) + (heightRange / 2)
        local targetPos = torso.Position + Vector3.new(0, verticalOffset, 0)
        bp.Position = targetPos

        -- Opcional: aplicar um pequeno BodyAngularVelocity para girar a bola e aumentar o efeito visual do fling
        if not Ball:FindFirstChild("BodyAngularVelocity") then
            local bav = Instance.new("BodyAngularVelocity")
            bav.AngularVelocity = Vector3.new(0, 20, 0)
            bav.MaxTorque = Vector3.new(0, math.huge, 0)
            bav.Parent = Ball
        end
    end)
end

-- Toggle Bola Vertical
Troll:AddToggle({
    Name = "Fling ball V2",
    Default = false,
    Callback = function(state)
        local target = game.Players:FindFirstChild(selectedPlayerName)
        if state then
            if target then
                BallVerticalLoop(target)
                print("Bola Vertical Ligada")
            else
                warn("Selecione um jogador!")
            end
        else
            if stopBallLoop then
                stopBallLoop()
                stopBallLoop = nil
                print("Bola Vertical Desligada")
            end
        end
    end
})
